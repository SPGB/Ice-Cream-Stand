function socket_bind(){socket.on("chat message",function(e){load_message(e)})}function sync(){$.ajax({url:"/chat",data:{expanded:20,cache:Math.random()},dataType:"JSON",success:function(e){for(var a=e.length-1,t=a;t>=0;t--)load_message(e[t])}})}function load_message(e){if(!($('.chat_container[x-id="'+e._id+'"]').length>0)){var a=e.badge?'<img class="chat_badge" src="http://static.icecreamstand.ca/badges/'+e.badge+'.png">':"",t=$("<div />",{"x-id":e._id,"class":"chat_container",title:e.created_at,html:'<a href="http://icecreamstand.ca/#!u/'+e.user+'" class="user_card">'+a+e.user+'</a><span class="chat_textbody">'+e.text+"</span>"});$(".chat_window").append(t),$(".chat_container").length>20&&$(".chat_container:first").remove()}}var user_me,socket;$(document).ready(function(){$.ajax({url:"/me",success:function(e){$(".chat_window").after('<form action="/chat" method="post"><input type="text" class="new_msg"><input type="submit" value="Send"></form>'),user_me=e;var a={query:"id="+user_me._id+"&name="+user_me.name};socket=io("http://icecreamstand.ca",a),sync(),socket_bind()}}),$("body").on("submit","form",function(){var e={badge:user_me.badges[0],text:$(".new_msg").val()};return socket.emit("chat message",e),$(".new_msg").val("").focus(),setTimeout(function(){sync()},250),!1})});