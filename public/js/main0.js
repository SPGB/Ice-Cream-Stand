function precise_round(e,a){return Math.round(e*Math.pow(10,a))/Math.pow(10,a)}function numberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function update_sell_value(){for(var e=0,a=flavors.length,t=0,s=toppings.length,r=0;s>r;r++){var o=toppings[r];if(o._id==user_me.last_addon){e+=o.value,cached_addon_value=o.value;break}}for(var r=0;a>r;r++){var n=flavors[r];if(n._id==user_me.last_flavor){cached_flavor_value=n.base_value;var i=n.value*(1+.1*cached_expertise)*(1+user_me.prestige_bonus/100);e+=i}for(var l=0;5>l;l++)if("string"==typeof user_me.flavors[l]&&user_me.flavors[l]==n._id){var c=1+.1*parseInt($("#main_base .option_wrapper").eq(l).find(".expertise_level").text()),i=cached_addon_value+n.value*c*(1+user_me.prestige_bonus/100);cached_worker_sell_value[l]=i,cached_worker_base_value[l]=n.value,t+=i;break}}user_me.last_flavor==trending_flavor&&""!=trending_flavor?($(".sell_value").append('<img src="img/banner_trending.png" class="banner" id="trending" />'),e+=user_me.trend_bonus):$(".banner#trending").remove(),user_me.last_addon==trending_addon&&""!=trending_addon?($(".sell_value").append('<img src="img/banner_event.png" class="banner" id="event" />'),e+=user_me.upgrade_heroic>0?1:.75):$(".banner#event").remove(),combo.value&&(e+=parseFloat(combo.value)),cached_sell_value=parseFloat(e).toFixed(2),$(".current_value").text(cached_sell_value);var d=5-.25*user_me.upgrade_machinery,u=user_me.flavors.length>=5?5:user_me.flavors.length;t/=u,cached_worker_value=t,isNaN(t)||$(".gold_sales span").text(numberWithCommas((sales_per/d*t*60).toFixed(2)))}function main(){console.log("running main()"),$.ajax({url:"/me",type:"GET",dataType:"JSON",success:function(e){user_me=e,gold=user_me.gold,disable_animations=user_me.animations_off,disable_chat=user_me.chat_off,e.total_gold>1e3&&"guest_"==e.name.substring(0,6)&&$("body").append('<h4 class="inline-message view_settings" id="guest" style="cursor:pointer;">Set a name and password!<br /><small>Secure your account, hover over your name at the bottom left and click settings</small></h4>'),$(".login #name").text(e.name).css("display","inline-block"),sales_per=user_me.carts+2*user_me.employees+3*user_me.trucks+5*user_me.robots+10*user_me.rockets,$("#unlock_machine .cost").text(numberWithCommas(15e3+15e4*user_me.upgrade_machinery)),$("#unlock_research .cost").text(numberWithCommas(50+user_me.upgrade_flavor*user_me.upgrade_flavor*100)),$("#unlock_addon .cost").text(numberWithCommas(75+user_me.upgrade_addon*user_me.upgrade_addon*100)),$("#unlock_heroic .cost").text(numberWithCommas(1e6+3e6*user_me.upgrade_heroic)),$("#unlock_legendary .cost").text(numberWithCommas(5e7+1e8*user_me.upgrade_legendary)),$("#unlock_cart .unlock_text span").text(numberWithCommas(25+Math.pow(user_me.carts,2)/4)),$("#unlock_cart .sale_level").text(user_me.carts),$("#unlock_employee .unlock_text span").text(numberWithCommas(150+100*user_me.employees)),$("#unlock_employee .sale_level").text(user_me.employees),$("#unlock_truck .unlock_text span").text(numberWithCommas(1e3+user_me.trucks*user_me.trucks*50)),$("#unlock_truck .sale_level").text(user_me.trucks),$("#unlock_robot .unlock_text span").text(numberWithCommas(5e3+user_me.robots*user_me.robots*100)),$("#unlock_robot .sale_level").text(user_me.robots),$("#unlock_rocket .unlock_text span").text(numberWithCommas(5e4+user_me.rockets*user_me.rockets*500)),$("#unlock_rocket .sale_level").text(user_me.rockets),$("#unlock_prestige .sale_level").text(user_me.prestige_level),user_me.upgrade_flavor>0&&$('.option[x-type="research"]').show(),user_me.upgrade_machinery>0&&$('.option[x-type="machine"]').show(),user_me.upgrade_addon>0&&$('.option[x-type="research_addon"]').show(),user_me.upgrade_heroic>0&&$('.option[x-type="heroic"]').show(),user_me.upgrade_legendary>0&&$('.option[x-type="legendary"]').show(),user_me.quests.length<5&&user_me.prestige_level<1&&$('.option[x-type="prestige"], #unlock_prestige').hide(),user_me.carts>0&&$('.option[x-type="sales_cart"]').show(),user_me.employees>0&&$('.option[x-type="sales_employee"]').show(),user_me.trucks>0&&$('.option[x-type="sales_truck"]').show(),user_me.robots>0&&$('.option[x-type="sales_robot"]').show(),user_me.rockets>0&&$('.option[x-type="sales_rocket"]').show(),user_me.upgrade_flavor>=23&&$("#unlock_heroic").show(),3==user_me.upgrade_heroic&&($("#unlock_legendary").show(),$("#unlock_heroic").hide()),2==user_me.upgrade_legendary&&$("#unlock_legendary .cost,#unlock_legendary button").hide(),user_me.upgrade_flavor>=23&&$(".upgrades_inner #unlock_research").hide(),user_me.upgrade_addon>=23&&$(".upgrades_inner #unlock_addon").hide(),user_me.flavors.length<=1&&$(".base_active").html("Click a base flavor to use it<br />Buy flavors on the right"),user_me.flavors.length>1&&$(".base_active").html("Drag flavors to rearrange<br />Workers automatically sell your top row"),user_me.flavors.length>2&&$(".base_active").text(""),user_me.carts>50&&achievement_register("52b535fd174e8f0000000001"),user_me.carts>=250&&achievement_register("52b53613174e8f0000000002"),1e3==user_me.carts&&achievement_register("52b5361e174e8f0000000003"),cached_flavor_length=user_me.flavors.length,get_prestige_bonus(user_me),$.ajax({url:"/flavors",type:"GET",dataType:"JSON",success:function(e){$("#upgrades .flavors_inner").text(""),flavors=e.reverse();for(i in user_me.flavors){var a;for(e in flavors)if(flavors[e]._id==user_me.flavors[i]){a=flavors[e];break}"object"==typeof a&&0==$('.option[x-id="'+a._id+'"]').length&&$(".flavor div#main_base").append('<div class="option_wrapper'+(.1==a.value?" outofstock":"")+'"><img src="img/'+a.name.replace(/\s+/g,"")+'_thumb.png" draggable="true" id="'+a.name.replace(/\s+/g,"")+'" '+(a.svg?'x-svg="true"':"")+' x-id="'+a._id+'" class="option" x-base-value="'+a.base_value+'" x-value="'+a.value+'" x-type="base" /></div>')}for(i in flavors){var a=flavors[i];"object"==typeof a&&0==$('.option[x-id="'+a._id+'"]').length&&$("#upgrades .flavors_inner").prepend('<div class="unlockable" id="'+a.name+'" x-id="'+a._id+'" x-type="base"><img src="img/'+a.name.replace(/\s+/g,"")+'_thumb.png"><div class="unlock_text">'+a.name.replace(/\s+/g,"")+" <span>"+numberWithCommas(a.cost)+"</span></div><button>UNLOCK</button></div>")}setTimeout("update_all_expertise()",100),setTimeout("update_sell_value()",50),$(".flavor.main_container .expand").hasClass("active")&&paginate(cached_page),0==$("#upgrades .flavors_inner").text().length&&(user_me.upgrade_flavor<23?$("#upgrades .flavors_inner").html($("#unlock_research")[0].outerHTML):user_me.upgrade_heroic<3?$("#upgrades .flavors_inner").html($("#unlock_heroic")[0].outerHTML):user_me.upgrade_legendary<2?$("#upgrades .flavors_inner").html($("#unlock_legendary")[0].outerHTML):$("#upgrades .flavors_inner").html("<h3>Every flavor is unlocked!</h3>")),$.ajax({url:"/toppings",type:"GET",dataType:"JSON",success:function(e){toppings=e,$("#upgrades .toppings_inner").text("");for(i in toppings){var a=e[i];-1==$.inArray(a._id,user_me.toppings)?$("#upgrades .toppings_inner").append('<div class="unlockable" id="'+a.name+'" x-id="'+a._id+'" x-type="addon"><img src="img/toppings/'+a.name.replace(/\s+/g,"")+'_thumb.png"><div class="unlock_text">'+a.name+" <span>"+numberWithCommas(a.cost)+"</span></div><button>UNLOCK</button></div>"):0==$('.option[x-id="'+a._id+'"]').length&&$(".flavor div#main_addon").prepend('<div class="option_wrapper"><img src="img/toppings/'+a.name.replace(/\s+/g,"")+'_thumb.png" id="'+a.name+'" x-id="'+a._id+'" class="option" x-value="'+a.value+'" x-type="addon" /></div>')}if(first_time){interval_gold=setInterval("update_gold()",50),interval_sell=setInterval("process_clicks()",1e3),update_trending(),setTimeout("update_event();",50),trend_event_active=!0,setTimeout("update_flavors();",1e4),setTimeout("get_quest();",1e3),first_time=!1,get_tutorial(),setTimeout("get_achievements()",100);var t=document.getElementById("canvas_main");canvas_drop_context=t.getContext("2d"),setInterval("canvas_icecream_drop()",50),user_me.chat_off||$('.flavor_tab[x-id="chat"]').click(),setInterval("sync_chat()",3e4)}clearInterval(interval_employees),interval_employees=setInterval("employees_working();",5e3-250*user_me.upgrade_machinery),setTimeout("update_worker_fx(0);",100),setTimeout("get_quests();",1e3),$('.flavor .option[x-id="'+user_me.last_flavor+'"]').eq(0).click(),$('.flavor .option[x-id="'+user_me.last_addon+'"]').eq(0).click(),"undefined"==user_me.last_addon&&$("#main_addon .option").eq(0).click(),0==$("#upgrades .toppings_inner").text().length&&(user_me.upgrade_addon<23?$("#upgrades .toppings_inner").html($("#unlock_addon")[0].outerHTML):user_me.upgrade_heroic<3?$("#upgrades .toppings_inner").html($("#unlock_heroic")[0].outerHTML):user_me.upgrade_legendary<2?$("#upgrades .toppings_inner").html($("#unlock_legendary")[0].outerHTML):$("#upgrades .toppings_inner").html("<h3>Every add-on is unlocked!</h3>"))}})}})},error:function(){console.log("error on main(), retrying"),setTimeout("main();",1e3)}})}function get_prestige_bonus(e){var a=e.gold,t=25*(a/(a+1e6)),s=e.flavors.length+e.toppings.length,r=s/171*25;$("#prestige_amount").text(parseFloat(t+r).toFixed(2))}function process_clicks(){0!=cache_sell_num&&(sell_icecream(cache_sell_num,!1),cache_sell_num=0,user_me.icecream_sold>=2e6&&achievement_register("5280ef1cb61b420000000009"),user_me.icecream_sold>=1e6&&achievement_register("5280ef12b61b420000000008"),user_me.icecream_sold>=5e5&&achievement_register("5280ef02b61b420000000006"),user_me.icecream_sold>=1e5&&achievement_register("5280eee1b61b420000000004"),user_me.icecream_sold>=1e4&&achievement_register("5280eeeab61b420000000005"),user_me.icecream_sold>=1e3&&achievement_register("5280ee78b61b420000000003"),user_me.icecream_sold>=100&&achievement_register("5280ee5fb61b420000000001"))}function sell_icecream(e,a){if(a){for(var t=-1,s=$(document).height(),r=$("#canvas_main").width(),o=0;5>o;o++){if(cached_worker_base_value[o]<=.1){t=o;break}window_focus&&canvas_drop_cache.length<30&&canvas_drop_cache.push([canvas_cache_workers[o],50*parseInt(Math.random()*r/50),-90+-100*o,s])}if(t>-1&&user_me.flavors.length>5){console.log("out of stock... ("+t+")");for(var n=$("#main_base .option_wrapper").eq(t),i=$(n)[0].outerHTML,l=(parseFloat($(n).find(".option").attr("x-base-value")),5),c="",o=5;o<user_me.flavors.length;o++)if(!$("#main_base .option_wrapper").eq(o).hasClass("outofstock")){l=o,c=$("#main_base .option_wrapper").eq(o).find(".option").attr("x-id");break}console.log(".. new place: "+l),$.ajax({url:"/switch",data:{1:$(n).find(".option").attr("x-id"),2:c},dataType:"JSON",type:"POST"});var d=user_me.flavors[t],u=user_me.flavors_sold[t];if(user_me.flavors[t]=user_me.flavors[l],user_me.flavors[l]=d,user_me.flavors_sold[t]=user_me.flavors_sold[l],user_me.flavors_sold[l]=u,!$("#main_base .option_wrapper")[l])return;$(n)[0].outerHTML=$("#main_base .option_wrapper")[l].outerHTML,$("#main_base .option_wrapper")[l].outerHTML=i,update_all_expertise(),setTimeout("update_sell_value()",50),update_worker_fx(0)}user_me.gold+=parseFloat(sales_per*cached_worker_value)}$.ajax({url:"/me",data:{g:precise_round(user_me.gold,2),d:cached_worker_value,a:e,addon:cached_addon_value,tf:trending_flavor==user_me.last_flavor,ta:trending_addon==user_me.last_addon,c:combo.value?combo.value:"false",e:cached_expertise,w:a},dataType:"JSON",type:"POST",success:function(e){if(connect_fails>4&&$(".inline-message#updated").remove(),!disable_animations&&$(".inline-message#animations").length>0&&setTimeout("$('.inline-message#animations').remove();",2e3),connect_fails=0,e.error)return debug_mode&&($(".inline-message").remove(),$("body").append('<h4 class="inline-message" id="animations">Debug error<br /><small>'+e.error+"</small></h4>")),void 0;if(e.gold){e.event&&alert(e.event),user_me.gold=e.gold,update_gold();for(var a=flavors.length,t=0;a>t;t++){var s=flavors[t];if(s._id==e._id&&s.value!=e.value)return s.value=e.value,update_sell_value(),void 0}}else for(var a=flavors.length,t=0;a>t;t++){var s=flavors[t];if(s._id==e._id&&s.value!=e.value)return s.value=e.value,update_sell_value(),void 0}disable_animations&&0==$(".inline-message#animations").length&&$("body").append('<h4 class="inline-message" id="animations">Animations are disabled<br /><small>workers are still working</small></h4>')},error:function(e){connect_fails++,connect_fails>5&&(0==$("#updated").length&&$("body").append('<h4 class="inline-message" id="updated">Connectivity issue<br /><small>please reload</small></h4>'),e.reload&&location.reload())}})}function update_worker_fx(e){0==e&&(canvas_cache_addon=document.getElementById("topping"));var a=$("#main_base .option").eq(e);if(!(0==$(a).length||e>=5||0==sales_per)){if(!disable_animations){if("number"!=typeof cached_worker_sell_value[e]||isNaN(cached_worker_sell_value[e]))return setTimeout("update_worker_fx("+e+")",1e3);$(a).parent().find(".icecream_float").remove(),$(a).parent().prepend('<div class="icecream_float">'+precise_round(cached_worker_sell_value[e],2).toFixed(2)+"</div>"),$('.icecream_particle[x-id="'+$(a).attr("id")+'"]').remove(),canvas_cache_workers[e]=new Image,canvas_cache_workers[e].src="true"==a.attr("x-svg")?"img/"+a.attr("id")+".svg":"img/"+a.attr("id")+".png"}setTimeout("update_worker_fx("+(e+1)+")",500+100*e)}}function employees_working(){sales_per>0&&sell_icecream(sales_per,!0)}function update_gold(){if(gold+=user_me.gold-gold>1e3?.75*(sales_per+1):.21,gold<user_me.gold&&gold>11){var e=numberWithCommas(parseFloat(gold).toFixed(2));$(".gold").text(e),isNaN(e)||$("title").text("$"+e+" - Ice Cream Stand")}else{var e=numberWithCommas(parseFloat(user_me.gold).toFixed(2));$(".gold").text(e),isNaN(e)||$("title").text("$"+e+" - Ice Cream Stand"),gold=user_me.gold}}function alert(e,a){$(".hovercard").remove(),"undefined"==typeof a&&(a="New Message"),$(".message, .darkness").remove(),$("body").append('<div class="message"><span id="title">'+a+'</span><span id="description">'+e+'</span><div class="button">ok</div></div><div class="darkness"></div>')}function achievement(e,a){$(".achievement_bubble").remove(),"undefined"==typeof e&&(e="unlocked"),$("body").append('<div class="achievement_bubble"><img src="img/achievement_thumb.png" /><span id="title">ACHIEVEMENT: '+e+'</span><span id="description">'+a+"</span></div>"),setTimeout("$('.achievement_bubble').fadeOut(1000);",1e4)}function cloud(){if(disable_animations)return setTimeout("cloud()",6e4),void 0;var e=Math.floor(10*Math.random()),a=Math.floor(100*Math.random());$(".cloud_wrapper").append('<div class="cloud" id="c1" style="top: '+(a+10)+'px;">'),5>e?$("#c1").animate({left:$(window).width()+600+"px"},2e4,function(){$("#c1").remove(),setTimeout("cloud()",5e4)}):($("#c1").css("left",$(window).width()+600+"px"),$("#c1").animate({left:"-600px"},2e4,function(){$("#c1").remove(),setTimeout("cloud()",5e4)}))}function update_flavors(){$.ajax({url:"/flavors",type:"GET",dataType:"JSON",success:function(e){flavors=e.reverse();for(i in e){var a=e[i];.1==a.value?$('#main_base .option[x-id="'+a._id+'"]:not(.outofstock)').parent(".option_wrapper:not(.outofstock)").addClass("outofstock"):$('#main_base .option.outofstock[x-id="'+a._id+'"]').parent(".option_wrapper.outofstock").removeClass("outofstock")}}}),setTimeout("update_flavors();",3e4)}function update_trending(){$.ajax({url:"/trending",dataType:"JSON",type:"GET",success:function(e){var a=(new Date).getSeconds();trending_flavor=e[0]._id;var t=user_me.trend_bonus.toFixed(2);0==$('.trend_title[x-id="'+trending_flavor+'"]').length?($('h2[x-step="1"]').html('<span class="trend_title tooltip" x-type="trending" x-id="'+trending_flavor+'">Upcoming</span><span class="currently_trending tooltip" x-type="base" x-id="'+e[0]._id+'" id="'+e[0].name.replace(/\s+/g,"")+'"><span id="trend_name">TRENDING<br /><img src="img/'+e[0].name.replace(/\s+/g,"")+'_thumb.png" class="trending_img active" title="'+e[0].name+'" /><small>'+e[0].name+'</small></span></span><span id="trend_time"><span id="trend_bonus">'+t+'</span><br /><div class="clock"><img src="img/clock_hand.svg" class="clock_hand" /></div><span class="trend_time"></span></span>'),$('.trend_title[x-type="trending"]').append('<br /><img src="img/'+e[1].name.replace(/\s+/g,"")+'_thumb.png" class="trending_img" title="'+e[1].name+'" /><img src="img/'+e[2].name.replace(/\s+/g,"")+'_thumb.png" class="trending_img" title="'+e[2].name+'" /><img src="img/'+e[3].name.replace(/\s+/g,"")+'_thumb.png" class="trending_img" title="'+e[3].name+'" />')):$('.trend_title[x-id="'+trending_flavor+'"] #trend_time').html('<span id="trend_bonus">'+t+'</span><br /><div class="clock"><img src="img/clock_hand.svg" class="clock_hand" /></div><span class="trend_time">'+e[0].mins+":"+a+"</span>");for(var s=60-a+60*parseInt(e[0].mins),r=s;r>0;r--)setTimeout("update_clock('.trend_time', "+r+");",1e3*(s-r));setTimeout("update_trending()",1e3*s)},error:function(){setTimeout("update_trending()",6e4)}})}function update_upcoming_trends(){$.ajax({url:"/trending",dataType:"JSON",type:"GET",success:function(e){for(var a=1;5>a;a++)$('.trend_title[x-type="trending"] img').eq(a).attr("src","img/"+e[a].name.replace(/\s+/g,"")+"_thumb.png").attr("title",e[a].name)}})}function update_clock(e,a){var t=Math.floor(a/60),s=a%60;$(e).text(t+":"+(10>s?"0"+s:s)),0==a&&(".event_time"==e&&($(e).closest(".event").hide(),trending_addon=""),update_sell_value())}function update_event(){$.ajax({url:"/event",dataType:"JSON",type:"GET",success:function(e){var a=(new Date).getSeconds(),t=user_me.upgrade_heroic>0?"1.00":"0.75";if(e._id){trending_addon=e._id;var s=e.event?e.event:e.event=e.name+" is HOT!";0==$('.event_title[x-id="'+trending_addon+'"]').length?$(".event").html('<span class="trend_title event_title tooltip" x-type="event" x-id="'+trending_addon+'">Add-on<br />event</span><span id="event_name" class="tooltip" x-type="event">'+s+'</span><span id="trend_time"><span id="trend_bonus">'+t+'</span><br /><div class="clock"><img src="img/clock_hand.svg" class="clock_hand" /></div><span class="event_time">'+a+"</span></span>").show():$('.event_title[x-id="'+trending_addon+'"] #trend_time').html('<span id="trend_bonus">'+t+'</span><br /><div class="clock"><img src="img/clock_hand.svg" class="clock_hand" /></div>'+e.mins+':<span class="trend_time">'+a+"</span>");for(var r=60-a+60*parseInt(e.mins),o=r;o>0;o--)setTimeout("update_clock('.event_time', "+o+");",1e3*(r-o));setTimeout("update_event()",1e3*r)}else $(".event").hide(),trending_addon="",update_sell_value(),setTimeout("update_event()",6e4)},error:function(){setTimeout("update_trending()",6e4)}})}function get_quest(){$.ajax({url:"new_quest",dataType:"JSON",success:function(e){e&&e.name&&(alert(e.description+"<br /><br /><b>Reward:</b> + $0.25 Trending bonus","New Quest! "+e.name),main(),setTimeout("get_quests();",1e3))}}),setTimeout("get_quest()",3e4)}function get_quests(){$.ajax({url:"quests",dataType:"JSON",success:function(e){if(quests=e,0!=user_me.quests.length){var a=user_me.quests[user_me.quests.length-1].split("&");user_me.quests.length>0&&"0"!=a[1]&&$('.flavor_tab[x-id="quests"]:not(.active)').click(),$(".quest_default").show();for(i in user_me.quests){var t=e[i];if("undefined"==typeof t)break;$(".quest_default").remove(),$('.quest[x-id="'+t._id+'"]').remove();var s=user_me.quests[i].split("&");if(s[2]){var r=s[2];t.description=t.description.replace("[cost]",r)}if($(".quest_list").prepend('<div class="quest" x-id="'+t._id+'"><div class="quest_title">'+t.name+"</div><p>"+t.description+"</p></div>"),"0"!=s[1]){0==t.level&&$(".quest:first p").append('<div class="quest_goal"><b>Goal</b>: Buy '+(r?r:5)+" Carts<br /><b>Reward</b>: + $0.25 trending bonus</div>"),1==t.level&&$(".quest:first p").append('<div class="quest_goal"><b>Goal</b>: Reseach Flavor and Research Addon (x'+(r?r:1)+" )<br /><b>Reward</b>: + $0.25 trending bonus</div>"),2==t.level&&$(".quest:first p").append('<div class="quest_goal"><b>Goal</b>: Become an expert '+(r?"("+r+")":"")+" with her favourite flavor<br /><b>Reward</b>: + $0.25 trending bonus</div>"),3==t.level&&$(".quest:first p").append('<div class="quest_goal"><b>Goal</b>: Buy '+(r?r:2)+" rockets<br /><b>Reward</b>: + $0.25 trending bonus</div>"),4==t.level&&$(".quest:first p").append('<div class="quest_goal"><b>Goal</b>: Sell 100 of '+(r?r:5)+" flavors<br /><b>Reward</b>: Unlocks next prestige tier, + $1.00 trending bonus</div>");var o=new Date(s[1]),n=new Date;n.setTime(o.getTime()+2*(t.level+1)*60*60*1e3);var l=(n.getTime()-o.getTime())/6e4,c="MINS";l>60&&(l/=60,c="HOURS"),$('.quest[x-id="'+t._id+'"]').append('<div class="button complete_quest">COMPLETE QUEST</div>')}else $('.quest[x-id="'+t._id+'"]').append('<center><img src="img/star.png" class="quest_star" /><b>COMPLETED</b></center>')}$(".quest").hide(),$(".quest:first").show()}}})}function get_tutorial(){$(".tutorial").remove(),0==user_me.tutorial&&$("body").append('<div class="tutorial tutorial_0"><h2>Selling Ice cream - 1/3</h2><b>CLICK THIS!</b> Clicking the ice cream sells it and you get money, win-win.<div class="button next_tutorial">NEXT</div><div class="triangle-left"></div></div>'),1==user_me.tutorial&&$("body").append('<div class="tutorial tutorial_1"><h2>Trends - 2/3</h2>Flavors are sometimes worth more for a short amount of time. Sell Trending flavors to make extra money!<div class="button next_tutorial">NEXT</div><div class="triangle-up"></div></div>'),2==user_me.tutorial&&$("body").append('<div class="tutorial tutorial_2"><h2>Buy all the things! - 3/3</h2>Buy better flavors, add-ons (which increase the value of your ice cream), workers to automatically sell ice cream for you, and upgrades.<div class="button next_tutorial">LET\'S START</div><div class="triangle-right"></div></div>'),user_me.total_gold>1e3&&3==user_me.tutorial?setTimeout(function(){$("body").append('<div class="tutorial tutorial_3" style="top: '+($(".fb-like").offset().top-50)+'px;"><h2>Sharing is caring</h2>If you enjoy Ice Cream Stand - please tell your friends by clicking "like" or  "send" below! It\'s very appreciated :)<div class="clearfix"></div><div class="button next_tutorial">no thanks</div><div class="button next_tutorial">sure</div><div class="triangle-down"></div></div>')},15e3):3==user_me.tutorial&&setTimeout("get_tutorial()",6e4)}function achievement_register(e){for(var a=user_me.achievements.length,t=0;a>t;t++)if(user_me.achievements[t]==e)return;user_me.achievements.push(e),$.ajax({url:"register_achievement",data:"id="+e,dataType:"JSON",type:"POST",success:function(e){e.name&&e.description?$(".achievement_bubble").length>0?setTimeout("achievement('"+e.name+"', '"+e.description+"')",1e4):achievement(e.name,e.description):console.log(e),get_achievements()}})}function get_achievements(){$.ajax({url:"achievements",dataType:"JSON",type:"GET",success:function(e){$(".achievement_list p").text("");for(i in e){var a=e[i],t=!1;for(n in user_me.achievements)user_me.achievements[n]==a._id&&(t=!0);t?$(".achievement_list p.unlocked").append("<div><b>"+a.name+"</b> - "+a.description+"</div>"):$(".achievement_list p.locked").append('<div style="opacity: 0.5;"><b>'+a.name+"</b> - "+a.description+"</div>")}user_me.achievements.length>0&&$('.flavor_tab[x-id="achievements"]:not(.active)').click()}})}function update_expertise(){var e=user_me.flavors.indexOf(user_me.last_flavor),a=user_me.flavors_sold[e];if(0!=cached_flavor_value){for(var t=0,s=0,r=0,o=0;10>=o;o++){var n=expertise_reqs[o]+100*cached_flavor_value+r;if(10==o||n>a){t=o,10>o?s=n:(s=0,a=0,r=0);break}r=n}cached_expertise!=t&&(1==t&&achievement_register("52857dd1def8030000000001"),5==t&&achievement_register("5287a8051834ee0000000003"),10==t&&achievement_register("5287a7dd1834ee0000000002"),cached_expertise=t,$('#main_base .option[x-id="'+user_me.last_flavor+'"]').parent().find(".expertise_level").text(t),update_sell_value(),setTimeout("update_worker_fx(0);",10));var i=100*((a-r)/(s-r));10==t&&(i=100),0==$(".expertise_bar_outer").length?$(".sell_value").after('<div class="expertise_bar_outer tooltip" x-type="expertise"><div class="expertise_bar_inner" style="width: '+i+'%;"></div><div class="expertise_hover">'+(a-r)+"/"+parseInt(s-r)+'</div><div class="expertise_number">Expertise level '+t+"</div></div>"):($(".expertise_bar_inner").css("width",i+"%"),$(".expertise_number").text("Expertise level "+t),$(".expertise_hover").text(a-r+"/"+parseInt(s-r)))}}function update_all_expertise(){for(var e=user_me.flavors.length,a=0;e>a;a++)for(var t=$("#main_base .option").eq(a),s=parseInt(100*t.attr("x-base-value")),r=0,o=0;10>=o;o++){var n=expertise_reqs[o]+s+r;if(user_me.flavors_sold[a]<n||10==o){0==t.parent().find(".expertise_level").length?t.after('<div class="expertise_level">'+o+"</div>"):t.parent().find(".expertise_level").text(o);break}r=n}}function paginate(e){var a=$(".inner_flavor_container:visible .option_wrapper").length;if(20>a)return $(".filter_box").remove(),void 0;cached_page=e;var t=5,s=Math.ceil((a-t)/15)-1;e>s&&(e=s),0>e&&(e=0),$(".filter_box").remove(),$(".inner_flavor_container:visible .option_wrapper").show(),$(".inner_flavor_container:visible .option_wrapper").slice(15*(e+1)+t,a).hide(),e>0&&$(".inner_flavor_container:visible .option_wrapper").slice(t,15*(e+1)-10).hide(),$(".inner_flavor_container:visible").after('<div class="filter_box"><div class="filter_prev button" onclick="paginate('+(e-1)+')"><img style="height: 20px;" src="img/arrow.svg"></div><div class="filter_next button" onclick="paginate('+(e+1)+')"><img style="height: 20px;" src="img/arrow_right.svg"></div></div>'),0==e&&$(".filter_prev").css("opacity","0.5"),e==s&&$(".filter_next").css("opacity","0.5");for(var r=e-2;e+3>r;r++)r>=0&&s>=r?$(".filter_box").append('<span class="filter_page '+(r==e?"active":"")+'" onclick="paginate('+r+')">'+(r+1)+"</span>"):$(".filter_box").append('<span class="filter_page" onclick="paginate(0)" style="opacity: 0">0</span>')}function init_canvas(){console.log("init canvas"),$("canvas").each(function(){$(this).attr("width",$(this).width()),$(this).attr("height",$(this).height())}),"object"==typeof canvas_cache_cone&&canvas_cache_cone.complete||(canvas_cache_cone=new Image,canvas_cache_cone.src="img/cone_thumb.png"),canvas_cache_icecream=new Image,canvas_cache_icecream.src="true"==$("#main_base .option.selected").attr("x-svg")?"img/"+$("#main_base .option.selected").attr("id")+".svg":"img/"+$("#main_base .option.selected").attr("id")+".png"}function canvas_icecream_drop(){if(!disable_animations&&window_focus){var e=canvas_drop_cache.length;if(0!=e){for(var a=10;e>50;)canvas_drop_context.clearRect(canvas_drop_cache[0][1],canvas_drop_cache[0][2]-2,50,90),canvas_drop_cache.shift(),e--;for(var t=0;e>t;t++){var s=canvas_drop_cache[t];canvas_drop_context.clearRect(s[1],s[2]-a,50,40),canvas_cache_cone&&canvas_cache_cone.complete&&s[0].complete&&"undefined"!=typeof s[0].naturalWidth&&s[0].naturalWidth>0&&(canvas_drop_context.drawImage(canvas_cache_cone,s[1]+5,s[2]+35,40,50),canvas_drop_context.drawImage(s[0],s[1],s[2],50,40),canvas_drop_context.drawImage(canvas_cache_addon,s[1],s[2],50,40)),s[2]+=a,s[2]-90>=s[3]&&(canvas_drop_context.clearRect(s[1],s[2]-2,50,90),canvas_drop_cache.shift(),t--,e--)}}}}function sync_chat(){$(".chat").is(":visible")&&($.ajax({url:"online",success:function(e){if(cached_online_count!=e.currently_online){cached_online_count=e.currently_online,$(".chat_container_list").html('<span class="currently_online">'+e.currently_online+" online</span>");for(var a=0;a<e.online.length;a++){var t=e.online[a],s=$("<div />",{text:t,"class":"user_card","x-user":t});$(".chat_container_list").append(s)}$(".friends_counter span#count").text(e.friends.length),$(".friends_counter user").remove("");for(var a=0;a<e.friends.length;a++)$(".friends_counter div").append($("<user />",{text:e.friends[a].name,"class":"","x-user":e.friends[a].name}))}}}),$.ajax({url:"chat",data:{expanded:$(".chat.main_container .expand").hasClass("active")?75:12},success:function(e){if(e[0].text!=cached_last_message){""==cached_last_message||window_focus||cached_new_messages++,console.log(cached_last_message+","+window_focus+","+cached_new_messages),cached_last_message=e[0].text,cached_new_messages>0&&$("title").text((1==cached_new_messages?"1 New Message":cached_new_messages+" New Messages")+" - Ice Cream Stand"),$("#chat_window").text("");for(var a=e.length-1,t=a;t>=0;t--){var s=e[t],r=$("<div />",{text:s.text,"class":"chat "+(s.is_admin?"admin":"normal"),"x-id":s._id});$(r).append('<time  class="timeago">'+s.timeago+" ago</time>"),$(r).prepend($("<span />",{text:s.user,"class":"user_card","x-user":s.user})),$("#chat_window").append(r)}}}}))}var user_me={name:"newbie",gold:0},flavors={},toppings={},gold=0,color_pool=["158248","3bade1","f2602f","c4336e","d44c72","3092b7","c368a3","239649","ded151","de558d","fff"],trending_flavor,trending_addon,first_time=!0,combo={},cached_sell_value=0,cached_worker_value=0,cached_addon_value=0,cached_flavor_length=0,cached_flavor_value=0,cached_worker_sell_value=[0,0,0,0,0],cached_worker_base_value=[0,0,0,0,0],cache_sell_num=0,sales_per=0,dragSrcEl=null,last_worker_fx=0,map_control_active="",connect_fails=0,quests={},trend_event_active=!1,disable_animations=!1,disable_chat=!1,debug_mode=!1,window_focus=!0,background_animation_num=0,expertise_reqs=[5,150,250,400,600,900,1600,2400,4e3,1e4,1e4],cached_expertise=0,canvas_drop_cache=[],cached_page=0,canvas_drop_context,canvas_cache_cone,canvas_cache_icecream,canvas_cache_workers=[0,0,0,0,0],canvas_cache_addon,cached_online_count=0,cached_last_message="",interval_employees,interval_gold,interval_sell,cached_new_messages=0;$(document).ready(function(){setTimeout("cloud()",2e4),main(),$("body").on("click",".flavor .flavor_tab",function(){$("#main_base, #main_addon, #main_combo").hide(),$("#"+$(this).attr("x-id")).show(),$(".flavor .flavor_tab.active").removeClass("active"),$(this).addClass("active"),$(".filter_box").remove(),$(this).parent().find(".expand").hasClass("active")&&paginate(0),"main_combo"==$(this).attr("x-id")&&$.ajax({url:"/me",type:"GET",dataType:"JSON",success:function(e){user_me=e,$.ajax({url:"/combos",type:"GET",dataType:"JSON",success:function(e){$(".flavor div#main_combo").html("<h5>Combos are different base flavor and add-on combinations that give bonus money when sold.</h5>");for(i in e){var a=e[i];for(k in user_me.combos)if(a._id==user_me.combos[k]){var t,s;for(n in flavors)if(t=flavors[n],t._id==a.flavor_id)break;for(n in toppings)if(s=toppings[n],s._id==a.topping_id)break;$(".flavor div#main_combo").prepend('<div class="option_wrapper"><div class="combo_option tooltip" x-type="combo" x-addon="'+s._id+'" x-flavor="'+t._id+'" x-value="'+a.value+'" x-name="'+a.name+'" style="background-image:url(\'img/toppings/'+s.name.replace(/\s+/g,"")+".png'), url('img/"+t.name.replace(/\s+/g,"")+"_thumb.png'), url('img/background_icons.png')\">"+a.name+"</div></div>")}}}})}})}),$("body").on("click",".highscores .flavor_tab",function(){return"hide"==$(this).attr("id")?($(".highscores").hide(),void 0):($(this).parent().find(".active").removeClass("active"),$(this).addClass("active"),$(".refresh_highscores").click(),void 0)}),$("body").on("click",".tab",function(){$(".tab.active").removeClass("active"),$(this).addClass("active"),$(".flavors_inner, .employees_inner, .upgrades_inner, .toppings_inner").hide(),$("."+$(this).attr("id")+"_inner").show()}),$("body").on("click",".controls_forward",function(){return $(".tab#flavors").hasClass("active")&&$(".flavors_inner .unlockable:visible").slice(0,5).hide(),$(".tab#toppings").hasClass("active")&&$(".toppings_inner .unlockable:visible").slice(0,5).hide(),!1}),$("body").on("click",".controls_show",function(){return $(".tab#flavors").hasClass("active")&&($(".flavors_inner .unlockable:hidden").show(),$(".flavors_inner").css("overflow-y","scroll")),$(".tab#toppings").hasClass("active")&&($(".toppings_inner .unlockable:hidden").show(),$(".toppings_inner").css("overflow-y","scroll")),!1}),$("body").on("click",".controls_back",function(){return $(".tab#flavors").hasClass("active")&&$(".flavors_inner .unlockable:hidden").slice(-5).show(),$(".tab#toppings").hasClass("active")&&$(".toppings_inner .unlockable:hidden").slice(-5).show(),!1
}),$("body").on("click",".flavor .expand",function(){"+"==$(this).text()?($("#main_base, #main_addon, #main_combo").addClass("expanded").css("overflow","visible"),paginate(0),$(this).text("-").addClass("active")):($("#main_base, #main_addon, #main_combo").removeClass("expanded").css("overflow","hidden"),$(this).text("+").removeClass("active"),$(".filter_box").remove())}),$("body").on("click",".quests .expand",function(){"+"==$(this).text()?($(".quest").show(),$(this).text("-").addClass("active")):($(".quest").hide(),$(".quest:first").show(),$(this).text("+").removeClass("active"))}),$("body").on("click",".achievements .expand",function(){"+"==$(this).text()?($(".locked").show(),$(this).text("-").addClass("active")):($(".locked").hide(),$(this).text("+").removeClass("active"))}),$("body").on("click",".chat.main_container .expand",function(){"+"==$(this).text()?($(".chat.main_container").attr("x-expand",!0),$("#chat_window").css("overflow-y","scroll"),$(this).text("-").addClass("active")):($(".chat.main_container").attr("x-expand",!1),$("#chat_window").css("overflow-y","hidden"),$(this).text("+").removeClass("active")),cached_last_message="",setTimeout("sync_chat()",50)}),$("body").on("change",".toggle_container input",function(){console.log("changing.."),$(this).parent().hasClass("toggle_animations")?disable_animations!=$(this).is(":checked")&&($.ajax({url:"toggle_animations",type:"POST"}),disable_animations=$(this).is(":checked"),update_worker_fx(0)):$(this).parent().hasClass("toggle_chat")?disable_chat!=$(this).is(":checked")&&($.ajax({url:"toggle_chat",type:"POST"}),disable_chat=$(this).is(":checked"),disable_chat?$(".chat.main_container").hide():$(".chat.main_container").show()):debug_mode=$(".toggle_debug input").is(":checked")}),$("body").on("mouseout",".option, .unlockable, .current_value, .tooltip, .hovercard",function(){$(".hovercard").remove()}),$("body").on("click",".inline-message",function(){$(this).hide()}),$("body").on("mouseover",".option, .unlockable, .current_value, .tooltip",function(){$(".hovercard").remove(),$("body").append('<div class="hovercard"><div>'+$(this).attr("id")+"</div></div>"),$(".hovercard").css("left",$(this).offset().left);var e,a=$(this).offset().top-20;console.log("hovercard top"+a),200>a&&(a+=275,e=!0),$(".hovercard").css("top",a);var t=$(this).attr("x-type");if(t&&"sales_cart"==t)$(".hovercard").html('<div>Cart<span class="level">'+user_me.carts+"</span></div><p>Carts automatically 1 sell ice cream.<br />Sells "+1*user_me.carts+" ice cream every "+(5-.25*user_me.upgrade_machinery)+' seconds</p><p class="flavor_text">Workers sell your top row. If an ice cream goes out of stock, they will automatically switch to the ice cream directly below.</p>');else if(t&&"sales_employee"==t)$(".hovercard").html('<div>Employees<span class="level">'+user_me.employees+"</span></div><p>Employees automatically sell 2 ice creams.<br />Sells "+2*user_me.employees+" ice creams every "+(5-.25*user_me.upgrade_machinery)+' seconds</p><p class="flavor_text">Workers sell your top row. If an ice cream goes out of stock, they will automatically switch to the ice cream directly below.</p>');else if(t&&"sales_truck"==t)$(".hovercard").html('<div>Truck<span class="level">'+user_me.trucks+"</span></div><p>Trucks automatically sell 3 ice creams.<br />Sells "+3*user_me.trucks+" ice cream every "+(5-.25*user_me.upgrade_machinery)+' seconds</p><p class="flavor_text">Workers sell your top row. If an ice cream goes out of stock, they will automatically switch to the ice cream directly below.</p>');else if(t&&"sales_robot"==t)$(".hovercard").html('<div>Robot<span class="level">'+user_me.robots+"</span></div><p>Robots automatically sell 5 ice creams.<br />Sells "+5*user_me.robots+" ice creams every "+(5-.25*user_me.upgrade_machinery)+' seconds</p><p class="flavor_text">Workers sell your top row. If an ice cream goes out of stock, they will automatically switch to the ice cream directly below.</p>');else if(t&&"sales_rocket"==t)$(".hovercard").html('<div>Rocket<span class="level">'+user_me.rockets+"</span></div><p>Rockets automatically sell 10 ice creams.<br />Sells "+10*user_me.rockets+" ice creams every "+(5-.25*user_me.upgrade_machinery)+' seconds</p><p class="flavor_text">Workers sell your top row. If an ice cream goes out of stock, they will automatically switch to the ice cream directly below.</p>');else if(t&&"machine"==t)$(".hovercard").html('<div>Ice Cream Machines<span class="level">'+user_me.upgrade_machinery+"</span></div><p>Increases the speed that you make ice cream. Currently it takes them "+(5-.25*user_me.upgrade_machinery)+" seconds, level up to decrease it by .25s</p>");else if(t&&"research"==t)$(".hovercard").html('<div>Flavor research<span class="level">'+user_me.upgrade_flavor+"</span></div><p>Each level unlocks 3 new flavors of ice cream</p>");else if(t&&"research_addon"==t)$(".hovercard").html('<div>Add-on research<span class="level">'+user_me.upgrade_addon+"</span></div><p>Each level unlocks 3 new add-ons for your ice cream</p>");else if(t&&"trending"==t){var s="";$(this).find("img").each(function(){s=s+$(this).attr("title")+", "}),$(".hovercard").html("<div>Trending</div><p>Upcoming trends: "+s+'</p><p class="flavor_text">Sell this flavor for a bonus before it falls out of favor. Trends change every 5 minutes, upcoming trends are listed under the UPCOMING title.</p>')}else if(t&&"event"==t)$(".hovercard").html("<div>Event</div><p>A mystery add-on is hot right now! Selling it brings in  bonus money.</p>");else if(t&&"friend"==t)$(".hovercard").html("<div>Friend</div><p>Make the Icecream Stand funner and play with friends. Every day your friends get 2% of any money you earn.</p>");else if(t&&"expertise"==t)$(".hovercard").css("left","10%"),$(".hovercard").html("<div>Expertise level</div><p>Sell this flavor to raise your expertise level. Higher value flavors are more difficult to master. Each level gives a bonus +10% to the flavor's value for you and your workers.</p>");else if(t&&"prestige"==t)if($(".hovercard").css("top",$(this).offset().top-50).css("height",180).css("font-size","12px"),user_me.prestige_level<8)$(".hovercard").html('<div>Prestige<span class="level">current: +'+user_me.prestige_bonus+"%</span></div><p><b>Restart the game with a bonus</b> based on your progress (current money, flavors, add-ons).</p><p>Everything except your stats (ice cream sold, total gold) will reset. Each level of Prestige increases the limit for workers by 100. You can upgrade Prestige only 8 times, after the lowest prestige bonus can be undone. Each time you upgrade you will get a bonus from 1-100% based on your progress. <b>This bonus adds with your past prestige bonuses.</b></p>");else{for(var r=user_me.prestige_array[0],o=1;o<user_me.prestige_array.length;o++)user_me.prestige_array[o]<r&&(r=user_me.prestige_array[o]);$(".hovercard").html('<div>Prestige<span class="level">current: +'+user_me.prestige_bonus+"%</span></div><p><b>Restart the game with a bonus</b>, overwriting your current lowest prestige score ("+r+"%)</p>")}else if(t&&"heroic"==t)$(".hovercard").html('<div>Heroic Tier<span class="level">'+user_me.upgrade_heroic+"</span></div><p>Unlock 3 high level flavors and add-ons. This can be upgraded 3 times.</p>");else if(t&&"legendary"==t)$(".hovercard").html('<div>Legendary Tier<span class="level">'+user_me.upgrade_legendary+"</span></div><p>Unlock 3 high level flavors and add-ons. This can be upgraded 2 times.</p>");else if(t&&"combo"==t){var n=parseFloat($(this).attr("x-value")),i=0,l=0;for(o in flavors)if(flavors[o]._id==$(this).attr("x-flavor")){i=flavors[o].value;break}for(o in toppings)if(toppings[o]._id==$(this).attr("x-addon")){l=toppings[o].value;break}$(".hovercard").html("<div>"+$(this).attr("x-name")+'<span class="level flavor_current">'+(n+i+l).toFixed(2)+"</span></div><p>Click this ice cream to switch to it for a bonus $"+$(this).attr("x-value")+'</p><p class="flavor_text">Combos are made by matching a certain base and addon into an even better flavor. Increases the value of the flavor.</p>')}else if(t&&"value"==t){$(".hovercard").css("top",$(this).offset().top-40+"px");var c=flavors[o];for(o in flavors)if(c=flavors[o],c._id==$("#main_base .selected").attr("x-id"))break;$(".hovercard").html("<div>"+$(".current_flavor").html()+'</div><p style="text-align: right;">Flavor value: $'+parseFloat(c.value).toFixed(2)+"<br />Add-on value: $"+parseFloat($("#main_addon .selected").attr("x-value")).toFixed(2)+"<br /></p>"),combo.value&&$(".hovercard p").append("Combo bonus: $"+combo.value.toFixed(2)+"<br />"),user_me.last_flavor==trending_flavor&&""!=trending_flavor&&$(".hovercard p").append("Trending bonus: $"+user_me.trend_bonus.toFixed(2)+"<br />"),user_me.last_addon==trending_addon&&""!=trending_addon&&$(".hovercard p").append("Event bonus: $"+(user_me.upgrade_heroic>0?"1.00":"0.75")+"<br />"),cached_expertise>0&&$(".hovercard p").append(cached_expertise+"0% Expertise bonus: $"+parseFloat(.1*c.value*cached_expertise).toFixed(2)+"<br />"),user_me.prestige_bonus>0&&$(".hovercard p").append(user_me.prestige_bonus+"% Prestige bonus: $"+parseFloat(c.value*(user_me.prestige_bonus/100)).toFixed(2)+"<br />"),$(".hovercard").css("left",$(this).offset().left-25+"px")}else if(t&&"base"==t)for(o in flavors){var c=flavors[o];if(c._id==$(this).attr("x-id")){var d=parseInt($(this).parent().find(".expertise_level").text());isNaN(d)&&(d=0);var u=c.value*(1+.1*d)*(1+user_me.prestige_bonus/100),p=c.base_value*(1+.1*d)*(1+user_me.prestige_bonus/100);trending_flavor==c._id&&(u+=user_me.trend_bonus);var _=user_me.flavors.indexOf(c._id),m=parseInt(user_me.flavors_sold[_])>0?user_me.flavors_sold[_]:"0";$(".hovercard").html("<div>"+c.name+'<span class="level flavor_current">'+u.toFixed(2)+"</span></div><p>"+c.description+"</p><p>Maximum value $"+parseFloat(p).toFixed(2)+". You've sold: "+m+'</p><p class="flavor_text">Flavor value fluctuates over time based on global number of sales.</p>');break}}else if(t&&"addon"==t)for(o in toppings){var v=toppings[o];if(v.name==$(this).attr("id")){$(".hovercard").html("<div>"+v.name+'<span class="level flavor_current">'+v.value.toFixed(2)+'</span></div><p>Add-ons can be used with a base flavor to increase the value of ice cream.</p><p class="flavor_text">Addons increase the value of every ice cream you or your workers sell and do not decrease in value over time like flavors.</p>');break}}e?$(".hovercard").append('<div class="triangle-up"></div>'):$(".hovercard").append('<div class="triangle-down"></div>')}),$("body").on("click",".prestige_cancel",function(){$(this).parent().find(".button").show(),$(this).parent().find("button").remove(),$(this).parent().find(".prestige_cancel").remove()}),$("body").on("click",".prestige_button",function(){$(this).after('<button>UNLOCK</button><div class="button prestige_cancel">CANCEL</div>'),$(this).hide()}),$("body").on("click",".currently_trending",function(){$(".option#"+$(this).attr("id")).click()}),$("body").on("click",".flavor .combo_option",function(){$('#main_base .option[x-id="'+$(this).attr("x-flavor")+'"]').click(),$('#main_addon .option[x-id="'+$(this).attr("x-addon")+'"]').click()}),$("body").on("click",'.flavor .option[x-type="addon"]',function(){$('.flavor .option[x-type="addon"].selected').removeClass("selected"),$(this).addClass("selected"),$(".icecream #topping").attr("src","img/toppings/"+$(this).attr("id").replace(/\s+/g,"")+".png").show(),$(".icecream #topping").attr("x-addon",$(this).attr("id")),user_me.last_addon=$(this).attr("x-id"),$.ajax({url:"last_flavor",data:"f="+user_me.last_flavor+"&a="+user_me.last_addon,dataType:"JSON",type:"POST",success:function(e){combo=e,update_sell_value(),e.name?($(".current_flavor").text(e.name),$(".banner#combo").remove(),$(".sell_value").append('<img src="img/banner_combo.png" class="banner" id="combo" />'),$()):($(".current_flavor").html($(".flavor .option.selected").attr("id")+"<br/>with "+$("#main_addon .selected").attr("id")),$(".banner#combo").remove())}});parseFloat($("#main_base .option.selected").attr("x-value"))+parseFloat($("#main_addon .option.selected").attr("x-value"))}),$("body").on("click",'.flavor .option[x-type="base"]',function(){if($('.flavor .option[x-type="base"].selected').removeClass("selected"),$(this).addClass("selected"),user_me.last_flavor==$(this).attr("x-id")){$(".icecream, .sell_value").css("display","block");var e="true"==$(this).attr("x-svg")?"svg":"png";$(".icecream").css("background-image",'url("../img/'+$(".flavor .option.selected").attr("id").replace(/\s+/g,"")+"."+e+'"), url("../img/cone.svg")'),combo.name?($(".current_flavor").text(combo.name),$(".banner#combo").remove(),$(".sell_value").append('<img src="img/banner_combo.png" class="banner" id="combo" />')):($(".current_flavor").text($(".flavor .option.selected").attr("id")),$("#main_addon .selected").length>0&&$(".current_flavor").append("<br/>with "+$("#main_addon .selected").attr("id")),$(".banner#combo").remove()),update_sell_value(),init_canvas(),update_expertise()}else user_me.last_flavor=$(this).attr("x-id"),$.ajax({url:"last_flavor",data:"f="+user_me.last_flavor+"&a="+user_me.last_addon,dataType:"JSON",type:"POST",success:function(e){combo=e,update_sell_value(),e.name?($(".current_flavor").text(e.name),$(".banner#combo").remove(),$(".sell_value").append('<img src="img/banner_combo.png" class="banner" id="combo" />')):($(".banner#combo").remove(),$(".current_flavor").text($(".flavor .option.selected").attr("id")),$("#main_addon .selected").length>0&&$(".current_flavor").append("<br/>with "+$("#main_addon .selected").attr("id"))),init_canvas(),update_expertise()}}),$(".icecream").parent().stop().animate({"margin-left":"-"+($(".icecream").offset().left+1e3)},1e3,function(){$(".icecream, .sell_value").css("display","block");var e="true"==$(".flavor .option.selected").attr("x-svg")?"svg":"png";$(".icecream").css("background-image",'url("../img/'+$(".flavor .option.selected").attr("id").replace(/\s+/g,"")+"."+e+'"), url("../img/cone.svg")'),$(".icecream").parent().animate({"margin-left":0},1e3)})}),$("body").on("click","#upgrades .unlockable button",function(){$(".upgrade_pending").removeClass("upgrade_pending"),$(this).hasClass("upgrade_success"),$(this).addClass("upgrade_pending"),$(this).hasClass("sell")&&$(this).addClass("upgrade_sell"),$.ajax({url:"/unlock",data:{id:$(this).closest(".unlockable").attr("x-id"),type:$(this).closest(".unlockable").attr("x-type"),sell:$(this).hasClass("sell"),amount:$(this).attr("x-amount")},dataType:"JSON",type:"POST",success:function(e){if(e.error)$(".upgrade_pending").addClass("upgrade_error").removeClass("upgrade_pending"),$(".upgrade_error").append('<div class="unlock_update">'+e.error+"</div>"),$(".unlock_update").animate({"margin-top":"-50px"},1e3,function(){$(this).remove(),$(".upgrade_error").removeClass("upgrade_error")});else{if(e.reload)return location.reload(!0);$(".upgrade_pending").addClass("upgrade_success").removeClass("upgrade_pending"),$(".upgrade_success").append('<div class="unlock_update">UNLOCKED</div>'),$(".upgrade_success").hasClass("upgrade_sell")&&($(".upgrade_success").removeClass("upgrade_sell"),$(".unlock_update").text("SOLD")),$(".unlock_update").animate({"margin-top":"-100px"},1e3,function(){$(".upgrade_success").trigger("mouseover").removeClass("upgrade_success"),$(this).remove()}),"base"==$(".upgrade_success").closest(".unlockable").attr("x-type")&&$("#main_base .option_wrapper").remove(),$(".hovercard").remove(),setTimeout("main()",20),setTimeout("update_upcoming_trends()",500)}},error:function(e){$(".upgrade_pending").addClass("upgrade_error").removeClass("upgrade_pending"),setTimeout("$('.upgrade_error').removeClass('upgrade_error')",1e3),console.log(e)}})}),window.onblur=function(){window_focus=!1},window.onfocus=function(){window_focus=!0,cached_new_messages>0&&($("title").text("Ice Cream Stand"),cached_new_messages=0)},$("body").on("click",".message .button",function(){$(".message, .darkness").remove()}),$("body").on("click",'.add_new[href="new_employee"]',function(){return $(this).after('<form action="employees" method="POST"><input name="name" placeholder="name"><input name="bio" placeholder="biography"><input name="speed" placeholder="starting leadership, 1-5"><input name="speed" placeholder="starting marketing, 1-5"><input name="speed" placeholder="starting analysis, 1-5"><input name="cost" placeholder="cost, 2000-5000"><input type="submit" class="button" value="CREATE"></form>'),$(this).remove(),!1}),$("body").on("click",'.add_new[href="new_flavor"]',function(){return $(this).after('<form action="flavors" method="POST"><input name="name" placeholder="flavor name"><input name="description" placeholder="flavor description"><input name="cost" placeholder="cost $200-500"><input name="base_value" placeholder="sell for  +2-3"><input type="submit" class="button" value="CREATE"></form>'),$(this).remove(),!1}),$("body").on("click",'.add_new[href="new_topping"]',function(){return $(this).after('<form action="toppings" method="POST"><input name="name" placeholder="topping name"><input name="topping description" placeholder="description"><input name="cost" placeholder="cost $0-300"><input name="base_value" placeholder="sell for +.5-1.5"><input type="submit" class="button" value="CREATE"></form>'),$(this).remove(),!1}),$("body").on("mousedown",".icecream",function(){cache_sell_num++,user_me.gold+=parseFloat(cached_sell_value),setTimeout(function(){$(".icecream").after('<div class="icecream_float" style="margin-top: 150px;color: #'+color_pool[Math.floor(10*Math.random())]+'">'+cached_sell_value+"</div>"),$(".icecream_float:first").animate({"margin-top":"0","margin-left":Math.floor(200*Math.random())-100+"px"},1e3,function(){$(this).remove()}),update_expertise()},50);var e=$(document).height();canvas_drop_cache.push([canvas_cache_icecream,50*parseInt(Math.random()*$("#canvas_main").width()/50),-90,e]),user_me.icecream_sold++;var a=user_me.flavors.indexOf(user_me.last_flavor);return user_me.flavors_sold[a]++,!1}),$("body").on("click",".view_settings",function(){return alert('<form action="user_update" method="POST" class="alert-form"><div class="clearfix">Your username: <input type="text" placeholder="USERNAME" name="username" value="'+user_me.name+'"></div><div class="clearfix">Your password: <input type="password" placeholder="OPTIONAL PASSWORD" name="password"></div><div class="clearfix">Release channel: <span style="float:right;"><input type="radio" name="release_channel" value="0" />main <input type="radio" name="release_channel" value="1" />beta <input type="radio" name="release_channel" value="2" />alpha</span></div><div class="clearfix" style="padding:20px 0;"><input type="submit" value="UPDATE"></div></form><div class="toggle_animations toggle_container"><input type="checkbox"> animations off</div><div class="toggle_debug toggle_container"><input type="checkbox"> debug mode</div><div class="toggle_chat toggle_container"><input type="checkbox"> chat</div>',"Update Your Settings"),$('.alert-form input[type="radio"][value="'+user_me.release_channel+'"]').attr("checked",!0),user_me.animations_off&&$(".toggle_animations input").attr("checked",!0),user_me.chat_off||$(".toggle_chat input").attr("checked",!0),debug_mode&&$(".toggle_debug input").attr("checked",!0),!1}),$("body").on("click",".view_stats",function(){return alert("Total gold: $"+user_me.total_gold.toFixed(2)+"<br />Ice cream sold: "+user_me.icecream_sold+"<br />Sales every "+(5-.25*user_me.upgrade_machinery)+" seconds: "+sales_per,"Stats"),$.ajax({url:"/online",dataType:"JSON",success:function(e){$(".message span#description").append("<br />Current players online: "+e.currently_online+"<br />Total number of accounts: "+e.number_of_accounts)}}),!1}),$("body").on("click",".nav_triangle",function(){$(".main_nav").is(":visible")?($(".main_nav").slideUp(500),$(this).addClass("inactive")):($(".main_nav").slideDown(500),$(this).removeClass("inactive"))}),$("body").on("click",".main_nav .flavor_tab",function(){$(this).hasClass("active")?($("."+$(this).attr("x-id")).hide(),$(this).removeClass("active")):($("."+$(this).attr("x-id")).show(),"chat"==$(this).attr("x-id")&&sync_chat(),$(this).addClass("active"))}),$("body").on("dragstart","#main_base .option",function(e){$(this).addClass("drag"),dragSrcEl=this,e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text/html",this.outerHTML),$(".hovercard").remove()}),$("body").on("dragend","#main_base .option",function(){$(this).removeClass("drag"),$(".option.over").removeClass("over")}),$("body").on("dragenter","#main_base .option",function(){$(this).addClass("over")}),$("body").on("dragleave","#main_base .option",function(){$(this).removeClass("over")}),$("body").on("dragover","#main_base .option",function(e){return e.preventDefault&&e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move",!1}),$("body").on("drop","#main_base .option",function(e){if(dragSrcEl!=this){dragSrcEl.outerHTML=this.outerHTML,this.outerHTML=e.originalEvent.dataTransfer.getData("text/html");var a=$(".option.over").attr("x-id"),t=$(".option.drag").attr("x-id"),s=user_me.flavors.indexOf(a),r=user_me.flavors.indexOf(t);user_me.flavors[s]=t,user_me.flavors[r]=a;var o=user_me.flavors_sold[s];user_me.flavors_sold[s]=user_me.flavors_sold[r],user_me.flavors_sold[r]=o,$.ajax({url:"/switch",data:"1="+a+"&2="+t,dataType:"JSON",type:"POST"}),setTimeout("update_worker_fx(0);",10),$(".option.over").parent().hasClass("outofstock")?($(".option.over").parent().removeClass("outofstock"),$(".option.drag").parent().addClass("outofstock")):$(".option.drag").parent().hasClass("outofstock")&&($(".option.drag").parent().removeClass("outofstock"),$(".option.over").parent().addClass("outofstock")),$(".option.over").removeClass("over"),$(".option.drag").removeClass("drag"),setTimeout("update_sell_value()",50),update_all_expertise()}return!1}),$("body").on("submit","#new_message",function(){return $.ajax({url:"chat",data:{text:$(this).find('input[type="text"]').val()},dataType:"JSON",type:"POST",success:function(e){if(e.text){var a=$("<div />",{text:e.text,"class":"chat","x-id":e._id});$(a).append('<time  class="timeago">now</time>'),$(a).prepend($("<span />",{text:e.user,"class":"user_card","x-user":e.user})),$("#chat_window").append(a),$("#chat_window .chat:first").remove(),$('#new_message input[type="text"]').val("").focus()}else setTimeout("sync_chat()",500)}}),!1}),$("body").on("click",".next_tutorial",function(){user_me.tutorial++,get_tutorial(),$.ajax({url:"tutorial",data:"tutorial="+user_me.tutorial,dataType:"JSON",type:"POST",success:function(){}})}),$("body").on("click",".complete_quest",function(){$(this).addClass("upgrade_pending"),$.ajax({url:"complete_quest",data:"id="+$(this).closest(".quest").attr("x-id"),dataType:"JSON",type:"POST",success:function(e){e.error?($(".upgrade_pending").addClass("upgrade_error").removeClass("upgrade_pending"),$(".upgrade_error").append('<div class="unlock_update" style="color:#111; width: 500px; text-align: center; margin-left: 0;">'+e.error+"</div>"),$(".unlock_update").animate({"margin-top":"-100px"},2e3,function(){$(".upgrade_error").removeClass("upgrade_error"),$(this).remove()})):("526745240fc3180000000002"==$(".upgrade_pending").closest(".quest").attr("x-id")?alert("Congratulations! Successfully completed the final quest, earning + $1.00 when a flavor trends.<br /><br /><b>All quests are now complete</b>","QUEST COMPLETE!"):alert("Congratulations! Successfully completed the quest, earning + $0.25 when a flavor trends.<br /><br /><b>The next quest will unlock soon.</b>","QUEST COMPLETE!"),$("#trend_bonus").text((parseFloat(user_me.trend_bonus)+.25).toFixed(2)),main(),$(".upgrade_pending").addClass("upgrade_success").removeClass("upgrade_pending"),$(".upgrade_success").append('<div class="unlock_update">QUEST COMPLETE</div>'),$(".unlock_update").animate({"margin-top":"-100px"},2e3,function(){$(".upgrade_success").removeClass("upgrade_success"),$(this).remove()}))},error:function(){$(".upgrade_pending").addClass("upgrade_error").removeClass("upgrade_pending"),setTimeout("$('.upgrade_error').removeClass('upgrade_error')",1e3)}})}),$("body").on("click","#donate",function(){alert('<p>100% of the donations go to making the game better! Leave me feedback with your email and account name and I\'ll let you know what your money was used for and give you a donation badge.</p><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" class="paypal"><input type="hidden" name="cmd" value="_s-xclick"><input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----MIIHRwYJKoZIhvcNAQcEoIIHODCCBzQCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYBqycKUAa1+ovSjflPGnchSTh/pUdN30LPDkbv+SOeF0PfwkU/dXkTUkU7aECEz7sXVfxMBDlf8A05mRulp3+6/oWqpDoFFJaIjROsU0lKTTc7w6TmfLWQpGd0pS7UGjWz1tNpu5vuH2pm0zbe7MgjFqtg1Grx4U91D+ENkIv+biTELMAkGBSsOAwIaBQAwgcQGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIYnVWkYxueF6AgaCATpvtUHl6kdq/zQWvqPN8l0AGUkDebydfcHDowTqyg2tUVfaPdC/OijI+oNYNCiuWyHQQROjzxMmAhQq/MfmRw9iG0KMKaBzKfwuoURPXgwiSCxKp2muEQGH7gmyAsjxR8YsEKIt7Yk8tO/lWQVeSmjHU2DTwdtLi3ZTZa/jedmodzJSR492vI+LVVmhBpnRjy0dgFhTy5NaRNqgGOVMroIIDhzCCA4MwggLsoAMCAQICAQAwDQYJKoZIhvcNAQEFBQAwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tMB4XDTA0MDIxMzEwMTMxNVoXDTM1MDIxMzEwMTMxNVowgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDBR07d/ETMS1ycjtkpkvjXZe9k+6CieLuLsPumsJ7QC1odNz3sJiCbs2wC0nLE0uLGaEtXynIgRqIddYCHx88pb5HTXv4SZeuv0Rqq4+axW9PLAAATU8w04qqjaSXgbGLP3NmohqM6bV9kZZwZLR/klDaQGo1u9uDb9lr4Yn+rBQIDAQABo4HuMIHrMB0GA1UdDgQWBBSWn3y7xm8XvVk/UtcKG+wQ1mSUazCBuwYDVR0jBIGzMIGwgBSWn3y7xm8XvVk/UtcKG+wQ1mSUa6GBlKSBkTCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb22CAQAwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQUFAAOBgQCBXzpWmoBa5e9fo6ujionW1hUhPkOBakTr3YCDjbYfvJEiv/2P+IobhOGJr85+XHhN0v4gUkEDI8r2/rNk1m0GA8HKddvTjyGw/XqXa+LSTlDYkqI8OwR8GEYj4efEtcRpRYBxV8KxAW93YDWzFGvruKnnLbDAF6VR5w/cCMn5hzGCAZowggGWAgEBMIGUMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbQIBADAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMTMxMDIxMTM0ODM4WjAjBgkqhkiG9w0BCQQxFgQU3lMSqWHF0gYuWLV9NpKHr3rU28IwDQYJKoZIhvcNAQEBBQAEgYCDIB2jz5mw85Z0Mb9XnJSS+0zUsEOAuazKSXGGUQVetRw57WMU2cq3UvDT7znpG2zxCk2ctiqwdP53aL5loRROKSrNu/hY3pFiSfkylZOTCftc6AZLMmtaVbgXSAb7C84ePYHwlbXX80tZoEVf0vI8UCF7jLEWo+C4oBVkTo5XeA==-----END PKCS7-----"><input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!"><img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1"></form>',"Donate")}),$("body").on("click","#invite",function(){alert('<p>Give your friend this URL to sign up with: <a href="http://icecreamstand.ca/sign_up?refer='+btoa(user_me.name)+'" target="_blank">http://icecreamstand.ca/sign_up?refer='+btoa(user_me.name)+"</a></p><p>once they complete the first quest it will count towards your number of referrals.</p>","Refer a friend")}),$("body").on("mouseout",".user_card",function(){$(".user_info_card").hide()}),$("body").on("mouseover",".user_card",function(){if($('.user_info_card[x-user="'+$(this).attr("x-user")+'"]').length>0)return $('.user_info_card[x-user="'+$(this).attr("x-user")+'"]').css("top",$(this).offset().top+20).css("left",$(this).offset().left).show(),void 0;var e=$("<div />",{text:"loading...","class":"user_info_card","x-user":$(this).attr("x-user")});$(e).css("top",$(this).offset().top+20).css("left",$(this).offset().left),$.ajax({url:"user/"+$(this).attr("x-user"),success:function(e){$('.user_info_card[x-user="'+e.name+'"]').html('<table><b><tr><td class="user_card_name">'+e.name+'</td></tr><tr><td><div class="prestige_levels"></div></td><td><div class="prestige_levels"><img src="img/favourite_icon.png" alt="prestige" /> '+e.favourite[0].name+"</div></td></tr><tr><td>Flavors: "+e.flavors+"</td><td>Addons: "+e.toppings+"</td></tr><tr><td>Quests: "+e.quests+"</td><td>Sold: "+numberWithCommas(e.sold)+"</td></tr><tr><td>Carts: "+e.carts+"</td><td>Employees: "+e.employees+"</td></tr><tr><td>Trucks: "+e.trucks+"</td><td>Robots: "+e.robots+"</td></tr><tr><td>Rockets: "+e.rockets+"</td><td></td></tr></table><time>Seen "+e.updated_at+" ago</time>"),e.prestige_level>0?$('.user_info_card[x-user="'+e.name+'"]').find(".prestige_levels:first").append('<img src="img/prestige_icon.png" alt="prestige" /> x'+e.prestige_level+" "+e.prestige_bonus+"%"):$('.user_info_card[x-user="'+e.name+'"]').find(".prestige_levels:first").append("-")}}),$("body").append(e)}),$("body").on("click",".friends_add",function(){"Add!"==$(this).text()?(""!=$(".friends_add_text").val()&&$.ajax({url:"friend/new",data:{friend:$(".friends_add_text").val()},type:"POST",dataType:"JSON",success:function(e){e.err&&alert(e.err),user_me.friends=e.friends,cached_online_count="",setTimeout("sync_chat()",500)}}),$(this).text("Add friend"),$(".friends_add_text").hide()):($(".friends_add_text").val("").show().focus(),$(this).text("Add!"))}),$("body").on("click",".view_highscores, .refresh_highscores",function(){$(".highscores").show();var e="all";return $("#this_week").hasClass("active")&&(e="week"),$("#this_day").hasClass("active")&&(e="today"),$("#referral").hasClass("active")&&(e="refer"),$.ajax({url:"/highscores",type:"GET",data:{type:e,limit:100},dataType:"JSON",success:function(e){$(".highscores ol").html("");var a=new Date,t=new Date(a.getTime()-18e5),s=10;$(".active#top_100").length>0&&(s=100);for(i in e){if(i>=s)break;var r=e[i],o=new Date(r.updated_at).getTime()>t?"online":"offline",n=0;r.total_gold&&(n=r.total_gold),r.today_gold&&(n=r.today_gold),r.week_gold&&(n=r.week_gold),r.referals?$(".highscores ol").append('<li class="'+o+' user_card" x-user="'+r.name+'"><span class="highscore_user">'+r.name+"</span>  &nbsp; "+r.referals+"</span></li>"):$(".highscores ol").append('<li class="'+o+' user_card" x-user="'+r.name+'"><span class="highscore_user">'+r.name+'</span>  &nbsp; <span class="flavor_current">'+numberWithCommas(precise_round(n,0))+"</span></li>")}},error:function(){$(".highscores ol").html("<div>Error loading highscores, please try again</div>")}}),!1})});